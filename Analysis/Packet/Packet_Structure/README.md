# Common Packet Structure

**The analysis below was conducted in Splatoon 2.**

# Overview

This article is about nn::pia::common::Packet class.

# Class Structure


```c
/*
   This file has been generated by IDA.
*/

#define __int8 char
#define __int16 short
#define __int32 int
#define __int64 long long


/* 806 */
struct __attribute__((aligned(8))) nn::pia::common::Packet::Header
{
  nn::pia::common::Packet::Header::vtable *vtable_;
  int magic_;
  char flag_;
  char padding1[3];
  int destination_variable_id_;
  int source_variable_id_;
  __int16 packet_id_;
  char footer_size_;
  __attribute__((packed)) __attribute__((aligned(1))) __int64 aes_gcm_nonce_;
  __attribute__((packed)) __attribute__((aligned(1))) __int64 aes_gcm_authentication_tag_;
  __attribute__((packed)) __attribute__((aligned(1))) __int64 unknown1;
  __attribute__((aligned(8))) char packet_[1472];
  int packet_size_;
  __attribute__((aligned(8))) int assign_size_;
  int unknown2;
  char nn::pia::common::StationAddress_[40];
  int unknown3;
};
```

## nn::pia::common::Packet::Header

The table below is a structure of nn::pia::common::Packet::Header class holding information on packets. This class contains various methods and data related to packets. 

| offset | type | Description |
| --- | --- | --- |
| 0 | offset | vtable |
| 8 | char[4] | magic (0x32AB9864) |
| C | u8 | 0x80: Encryption enabled / 0x7F: Version number (9) |
| D | padding | 3 empty bytes |
| 10 | u32 | destination variable id |
| 14 | u32 | source variable id |
| 18 | u16 | packet id |
| 1A | u8 | footer size |
| 1B | u8[8] | AES-GCM nonce |
| 23 | u8[8] | AES-GCM authentication tag (first 8 bytes) |
| 2B | u64 | unknown |
| 33 | padding | 5 empty bytes |
| 38 | u8[0x5C0] | Packet(0:Packet Header, 0x20:Packet Data?) |
| 5F8 | u32 | assign size? |
| 5FC | u32 | unknown |
| 600 | nn::pia::common::StationAddress |  |
| 628 | u32 | unknown |
| 62C | padding | 4 empty bytes |
| 630 | nn::pia::common::StationAddress |  |
| 658 | u8 | unknown |

# VTable Structure

This is a vtable structure of nn::pia::common::Packet::Header class

| offset | function name | description |
| --- | --- | --- |
| 0 | nn::pia::lan::LanMessage::refunc_ |  |
| 8 | nn::pia::common::Packet::Header::~Header | destucture |
| 10 | nn::pia::common::Packet::Header::Serialize | Serialize Packet (Inserts header to a packet) |
| 18 | nn::pia::common::Packet::Header::Deserialize | Deserialize Packet (Parses packet’s header) |
| 20 | nn::pia::common::Packet::Header::GetSerializedSize | Header size(always 0x20) |

# Methods

Below is a list of methods of nn::pia::common::Packet. 

| function name | description |
| --- | --- |
| nn::pia::common::Packet::PacketData::SerializeHeader | Serialize Packet (Inserts header to a packet) |
| nn::pia::common::Packet::Header::Serialize | Serialize Packet (Inserts header to a packet) |
| nn::pia::common::Packet::PacketData::DeserializeHeader | Deserialize Packet (Parses packet’s header) |
| nn::pia::common::Packet::Header::Deserialize | Deserialize Packet (Parses packet’s header) |
| nn::pia::common::Packet::PacketData::GetPayload | Get PacketData |
| nn::pia::common::Packet::Packet | Constructure |
| nn::pia::common::Packet::Reset | Reset Packet |
| nn::pia::common::Packet::~Packet | Distucture |
| nn::pia::common::Packet::IsValid | Is Packet Valid |
| nn::pia::common::Packet::AssignPayload | Assign Size |
| nn::pia::common::Packet::AssignFooter | Assign footer size |
| nn::pia::common::Packet::CopyFrom | Copy from lvalue |
| nn::pia::common::Packet::Encrypt | Encrypt Packet |
| nn::pia::common::Packet::Decrypt | Decrypt Packet |
| nn::pia::common::Packet::Header::~Header | Distructure |
| nn::pia::common::Packet::Header::GetSerializedSize | Header size(always 0x20) |

# Reference
- https://github.com/kinnay/NintendoClients/wiki